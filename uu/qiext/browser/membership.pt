<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="uu.qiext">
<head>
  <metal:block fill-slot="javascript_head_slot">
<script type="text/javascript">
jQuery(document).ready(function() {
    /* overlays */
    jQuery('a.add-user-entry').prepOverlay({
         subtype: 'ajax',
         filter: 'div.page_section.existing_users',
         formselector: 'div.existing_users form.user_search',
        });
    jQuery('a.register-user-entry').prepOverlay({
         subtype: 'ajax',
         filter: 'div.page_section.register_user',
        });
    jQuery('td.userinfo a.userinfo').prepOverlay({
         subtype: 'ajax',
         filter: '#content',
        });
    jQuery('td.gridcell a.purge').prepOverlay({
         subtype: 'ajax',
         filter: '#content',
         formselector: '#content form.user-purge-form',
         closeselector: '#content form.user-purge-form input.cancelbutton',
         noform: 'reload',
         config: {
            onClose: function(e) {
                var input = jQuery('#content form.user-purge-form input.cancelbutton');
                if (input.val() == 'Ok') {
                    /* on success (not cancel): reload after either GET, POST, idea via http://goo.gl/Lrc4j */
                    window.location.href = window.location.pathname + window.location.search;
                }
            }
         }
        });

    /* modified grid table cell/row highlighting cues */
    jQuery('table.listing td input').click(function(event) {
        jQuery(this).parent().addClass('modified');
        jQuery(this).parent().parent().addClass('modified');
    });

    /* unlock viewers checkbox */
    jQuery('table.listing td a.unlock').click(function(event) {
        jQuery(this).parent().children('input.locked').show();
        jQuery(this).parent().children('a.purge').show().addClass('block');
        jQuery(this).parent().children('a.password-reset').show().addClass('block');
        jQuery(this).parent().children('.checkmark').hide();
        jQuery(this).hide();
    });

});

</script>
  </metal:block>
  <metal:block fill-slot="style_slot">
<style>
div.page_section {
  border: 1px solid #bbb;
  margin-bottom:1.2em;
  padding: 0.2em 0.5em;
  clear:both;
}

div.page_section h3 {
  width:100%;
  background-color:#ddd;
  color:black;
  font-size:120%;
  margin:-0.2em -0.5em;
  padding:0.2em 0.5em;
  margin-bottom:0.4em;
  border-bottom:1px solid black;
}

div.search_result div.user_result {
  font-size:90%;
}

table.listing th, table.listing td {
  font-size:90%;
  padding: 0.2em 0.4em;
}

table.listing td a.unlock img, table.listing td a.userinfo {
  opacity:0.6;
  filter:alpha(opacity=60); /* MSIE 8 and below*/
}

table.listing td a.userinfo {
  border:none !Important;
  float:right;
}

table.listing td a.purge, table.listing td input.locked, table.listing td a.password-reset { display:none; }
table.listing td a.purge { font-size:90%; color:red !important; background-color:yellow; border:1px solid red; font-weight:bold; }
#content table.listing td a.purge.block { display:block !Important; margin-top:1.6em; border-bottom:1px solid red !important; }
table.listing td a.password-reset { font-size:90%; color:#449 !important; background-color:#ddd; border:1px dotted blue; font-weight:bold; }
#content table.listing td a.password-reset.block { display:block !Important; margin-top:1.6em; border-bottom:1px dotted blue !important; }

table.listing td.gridcell {
  text-align:center;
}

table.listing tr.modified td {
    background-color: #ff9 !important;
}

table.listing tr td.modified {
    background-color: #fd9 !important;
}

table.listing td.userinfo div.email a {
  font-size:80%;
  color:#009;
}

p.help { margin-left:2em; font-style:italic; font-size:85%; color:#999; }

div.page_section.existing_users { display:none; }
div.pb-ajax div.page_section.existing_users { display:block !Important; }

div.page_section.register_user { display:none; }
div.pb-ajax div.page_section.register_user { display:block !Important; }

a.add-user-entry:before { content:"* "; font-size:1.8em; color:#bdb; font-weight:bold; background-image:url("./user.png"); background-repeat:no-repeat; background-position:bottom right; padding:0.1em 0.2em; }

a.add-user-entry { border:1px solid #9ba; background-color:#eff; margin:1em 0.2em 1em 0; padding:0.5em; display:block; width:46%; float:left; font-size:90%; -moz-outline-style: none !Important; height:2em; }

a.register-user-entry:before { content:"+ "; font-size:1.6em; color:#060; font-weight:bold; background-image:url("./user.png"); background-repeat:no-repeat; background-position:bottom right; padding:0.1em 0.2em; }

a.register-user-entry { border:1px solid #9ba; background-color:#ffe; margin:1em 0.2em 1em 0; padding:0.5em; display:block; width:46%; float:left; clear:none; font-size:90%; -moz-outline-style: none !Important; outline-style:none; height:2em; }

div.membership-action-buttons { border: 1px solid #999; }

#content a.link-overlay { border-bottom:0.2em solid #687 !important; border-right:0.2em solid #687; } 
#content td.userinfo a.link-overlay { border-bottom:none !important; border-right none !important; }

</style>
  </metal:block>
</head>
<body>
<div metal:fill-slot="main" tal:define="workspace_title python:'project' if context.portal_interface.objectImplements(context, 'uu.qiext.interfaces.IProjectContext') else 'workspace'">

 <h1>Manage workgroup memberships</h1>
 <h2 style="color:#687;font-size:130%;margin-left:2em;"><em tal:content="context/Title">TITLE</em><strong tal:condition="python:workspace_title=='project'"> (Project)</strong></h2>


 <div class="membership-action-buttons">

   <a class="register-user-entry" href="@@workspace_membership">&nbsp; Register new user, add to workspace</a>
   <a class="add-user-entry" href="@@workspace_membership">&nbsp; Search for existing site users to add</a>

 </div>

 <div class="page_section">  <!-- Membership roles grid for existing members/viewers -->
   <h3>Manage the group assignments of current <span tal:replace="workspace_title">workspace</span> members:</h3>
   <p>There are <span tal:replace="python:len(view.roster)">#</span> workgroup members for this <span tal:replace="workspace_title">workspace</span>, being assigned at minimum the "<span tal:replace="python:workspace_title.title()">Workspace</span> Viewers" group assignment.</p>
   <p class="help">To remove a user or send password email, click the lock icon (<img src="./lock_icon.png" />) in the <span tal:replace="python:workspace_title.title()">Workspace</span> Viewers column to unlock the user for password reset or removal from project and/or site.  To get more information about a user, click on the info icon (<img src="./info_icon.png" />) next to the user.</p>
   <form method="POST">
    <table class="listing" tal:define="groups view/groups; cols python:len(groups);">
     <tr class="odd">
       <th rowspan="2">User name, email</th>
       <th colspan="4" style="color:black;" tal:attributes="colspan cols"><span tal:replace="python:workspace_title.title()">Workspace</span> group assignments</th>
     </tr>
     <tr class="odd">
       <th tal:repeat="group groups">
        <span tal:replace="group/title"></span>
       </th>
     </tr>
     <tr tal:repeat="user view/roster/values">
      <tal:block define="email python:user.getProperty('email');
                         fullname python:user.getProperty('fullname');
                         groups python:view.groups(email);">
       <td class="userinfo">
         <input type="hidden" tal:attributes="name string:managegroups-${email}" value="managed" /> 
         <div><span tal:replace="fullname">NAME</span> <a href="" class="userinfo" tal:attributes="href string:./@@user_info?principal=${email}"><img src="./info_icon.png" /></a></div>
         <div class="email">
           <a href="" tal:attributes="href string:mailto:${email}">&lt;<span tal:replace="email">EMAIL</span>&gt;</a>
         </div>
       </td>
       <td class="gridcell" tal:repeat="group groups">
         <tal:block condition="python:group['groupid'] == 'viewers'">
           <strong class="checkmark" style="font-size:200%;color:#999;">&#x2713;</strong>
           <input type="checkbox"
                  class="locked"
                  name=""
                  checked="CHECKED"
                  tal:condition="python: group['checked']"
                  tal:attributes="name string:group-${group/groupid}/${email}"
                  />
           <a class="unlock"><img src="./lock_icon.png" alt="unlock" /></a>
           <a href="#" class="password-reset"><img src="./mail_icon.png" alt="email password reset" /> Send password reset email</a>
           <tal:block condition="python:view.roster.can_purge(user.getId())">
            <a href=""
               class="purge"
               tal:attributes="href string:./@@user_purge?purgeuser=${email}"
                >
                <img src="./delete_icon.png" alt="purge user from site permanently" /> (Permanently Remove)</a>
           </tal:block>
         </tal:block>
         <tal:block condition="python:group['groupid'] != 'viewers'">
           <input type="checkbox"
                  name=""
                  tal:condition="python: not group['checked']"
                  tal:attributes="name string:group-${group/groupid}/${email}"
                  />
           <input type="checkbox"
                  name=""
                  checked="CHECKED"
                  tal:condition="python: group['checked']"
                  tal:attributes="name string:group-${group/groupid}/${email}"
                  />
         </tal:block>
       </td>
      </tal:block>
     </tr>
    </table>
    <input name="grid_update" type="submit" value="Update workspace roles" />
   </form>
 </div>


 <div class="page_section existing_users">
  <h3>Search existing site members not yet members of this <span tal:replace="workspace_title">workspace</span>:</h3>
  <p class="help">
    Search for users already part of other projects or teams not 
    yet a member of this <span tal:replace="workspace_title">workspace</span>.  You may select users from the
    result for addition to this <span tal:replace="workspace_title">workspace</span>.
  </p>

  <div class="search_result" tal:condition="view/search_user_result" style="margin-bottom:1em;">
   <form method="POST">
   <h4>Search results for query: <span tal:content="request/search_user_query">Q</span></h4>
   <div class="user_result" tal:repeat="result view/search_user_result">
     <input type="checkbox" name="" tal:attributes="name string:addmember-${result/email}" />&nbsp;<span tal:content="result/fullname"></span> (<span tal:replace="result/email"></span>)
   </div>
   <input type="submit" name="select_existing_users" value="Add selected users to workspace membership" style="margin-top:1em;" />
   </form>
  </div>

  <form class="user_search" method="POST" style="display:block; margin-left:1em; background-color:#999; padding:1em; width:22em; margin-bottom:1em;" >
  <div>
  <label style="display:block;">Search for user (name, email)</label>
  <input name="search_user_query" />
  <p class="help">Note: site users who already have workspace membership will be omitted from any result.</p>
  </div>
  <br />
  <input name="search_users" type="submit" value="Search existing site users" />
  </form>

 </div>

 <div class="page_section register_user">
   <h3>Register a new site member, add to <span tal:replace="workspace_title">workspace</span>:</h3>
  <p class="help">Create a new user not yet registered for this site, and add that user as a <span tal:replace="workspace_title">workspace</span> member.</p>
  <form method="POST" style="display:block; margin-left:2em;" >
  <div>
   <label style="display:block;">E-mail address</label>
   <input name="newuser_email" />
  </div>
  <div style="margin-top:0.5em;">
   <label style="display:block;">Full name</label>
   <input name="newuser_fullname" />
  </div>
  <div style="margin-top:0.5em;">
   <input name="newuser_sendmail" type="checkbox" checked="CHECKED" />
   <label style="display:block;"><em>Send welcome (password setup) email to user.</em></label>
  </div>
  <br />
  <input name="register_new_user" type="submit" value="Register new user" />
  </form>
  <p class="help">
      The member's e-mail address will be the ID used to login. By adding a new user,
      an initial random password and notification email to the user's email will be 
      generated. The link sent to the user in the notification email will present 
      the opportunity for the user to select their own password.
  </p>
 </div>

</div>
</body>
</html>
